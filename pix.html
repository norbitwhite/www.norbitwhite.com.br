<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Pagamento PIX - Campeonato</title>

<style>
*{box-sizing:border-box;font-family:Arial,Helvetica,sans-serif}
body{
  margin:0;
  min-height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
  background:#0b0b10;
  color:#fff;
  padding:18px;
  flex-direction:column;
}
.card{
  width:100%;
  max-width:520px;
  background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.10);
  border-radius:18px;
  padding:18px;
}
h1{margin:0 0 6px;font-size:22px}
p{margin:0 0 14px;color:rgba(255,255,255,.75);font-size:14px}
label{display:block;margin:12px 0 6px;font-size:13px;color:rgba(255,255,255,.85)}
input,select{
  width:100%;
  padding:12px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(0,0,0,.25);
  color:#fff;
  outline:none
}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.btn{
  width:100%;
  margin-top:14px;
  padding:13px;
  border:none;
  border-radius:14px;
  background:linear-gradient(90deg,#6f00ff,#a100ff);
  color:#fff;
  font-weight:800;
  cursor:pointer
}
.btn:disabled{opacity:.6;cursor:not-allowed}
.box{
  margin-top:14px;
  padding:12px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.22)
}
.hidden{display:none}
#qr{width:100%;margin-top:10px;border-radius:12px;background:#fff;padding:8px}
.footer{
  margin-top:30px;
  text-align:center;
  font-size:13px;
  color:rgba(255,255,255,.6);
}
.small{font-size:12px;color:rgba(255,255,255,.75);line-height:1.4;white-space:pre-wrap}
.total{
  margin-top:10px;
  font-weight:900;
  color:rgba(255,255,255,.92);
}
</style>
</head>

<body>

<div class="card">
  <h1>Pagamento via PIX</h1>
  <p>Preencha seus dados e gere o QR Code. A confirmação acontece automaticamente após o pagamento.</p>

  <form id="form">
    <label>WhatsApp (com DDD)</label>
    <input id="whatsapp" placeholder="Ex: 21999998888" inputmode="numeric" required />

    <div class="row">
      <div>
        <label>Nome (opcional)</label>
        <input id="nome" placeholder="Seu nome" />
      </div>

      <div>
        <label>Email (opcional)</label>
        <input id="email" type="email" placeholder="seuemail@email.com" />
      </div>
    </div>

    <label>Valor Base</label>
    <input value="R$ 15,00" disabled />

    <label>Donate (GORJETA)</label>
    <select id="extra">
      <option value="0">Sem donate</option>
      <option value="0.5">Donate R$ 0,50</option>
      <option value="1">Donate R$ 1,00</option>
      <option value="2">Donate R$ 2,00</option>
      <option value="5">Donate R$ 5,00</option>
    </select>

    <label>Descrição</label>
    <input id="descricao" value="Inscrição Campeonato Warzone" readonly />

    <div class="total" id="valorFinal"></div>

    <button class="btn" id="btn" type="submit">GERAR PIX</button>
  </form>

  <div class="box hidden" id="areaPix">
    <div id="msg" class="small">Gerando...</div>

    <img id="qr" class="hidden" alt="QR Code PIX" />

    <!-- ✅ NOVO: link + copia e cola -->
    <div id="paylinkWrap" class="hidden" style="margin-top:10px;">
      <a id="paylink" class="btn" href="#" target="_blank" rel="noopener noreferrer"
         style="display:block;text-align:center;text-decoration:none;">
        ABRIR LINK DE PAGAMENTO
      </a>
    </div>

    <div id="copyWrap" class="hidden" style="margin-top:10px;">
      <div class="small" style="margin-bottom:6px;">Copie e cole o código PIX:</div>

      <textarea id="pixCode" readonly
        style="width:100%;height:110px;border-radius:12px;padding:10px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.25);color:#fff;outline:none;resize:none"></textarea>

      <button class="btn" id="copyBtn" type="button" style="margin-top:10px;">
        COPIAR CÓDIGO PIX
      </button>
    </div>

    <div id="debug" class="small" style="margin-top:10px;"></div>
  </div>
</div>

<div class="footer">
  © 2026 Norbit White • Campeonato Warzone
</div>

<script>
const API_BASE = "https://norbitwhite-github-io.vercel.app";

const form = document.getElementById("form");
const btn = document.getElementById("btn");
const extraSelect = document.getElementById("extra");
const valorFinalEl = document.getElementById("valorFinal");

const areaPix = document.getElementById("areaPix");
const msg = document.getElementById("msg");
const qrImg = document.getElementById("qr");
const debug = document.getElementById("debug");

// ✅ novos
const paylinkWrap = document.getElementById("paylinkWrap");
const paylink = document.getElementById("paylink");
const copyWrap = document.getElementById("copyWrap");
const pixCode = document.getElementById("pixCode");
const copyBtn = document.getElementById("copyBtn");

const VALOR_BASE = 15;
let pollTimer = null;

function onlyDigits(s){ return (s||"").replace(/\D/g,""); }

function moneyBR(v){
  return "R$ " + (Number(v)||0).toFixed(2).replace(".", ",");
}

function getTotal(){
  const extra = Number(extraSelect.value || 0);
  const total = Number((VALOR_BASE + extra).toFixed(2));
  return { extra, total };
}

function refreshTotal(){
  const { total } = getTotal();
  valorFinalEl.textContent = "Total: " + moneyBR(total);
}
refreshTotal();
extraSelect.addEventListener("change", refreshTotal);

async function criarPagamento(payload){
  const res = await fetch(`${API_BASE}/api/criar-pagamento`, {
    method: "POST",
    headers: { "Content-Type":"application/json" },
    body: JSON.stringify(payload)
  });

  const raw = await res.text();
  let data = {};
  try { data = JSON.parse(raw); } catch {}

  if(!res.ok){
    throw new Error(`Erro API (${res.status}): ${data.error || data.message || raw}`);
  }
  return data;
}

async function consultarStatus(paymentId){
  const res = await fetch(`${API_BASE}/api/status?payment_id=${encodeURIComponent(paymentId)}`);
  const raw = await res.text();
  let data = {};
  try { data = JSON.parse(raw); } catch {}

  if(!res.ok){
    throw new Error(`Erro STATUS (${res.status}): ${data.error || data.message || raw}`);
  }
  return data;
}

function startPolling(paymentId){
  if(pollTimer) clearInterval(pollTimer);

  pollTimer = setInterval(async ()=>{
    try{
      const st = await consultarStatus(paymentId);

      if(st.status === "approved"){
        clearInterval(pollTimer);
        msg.textContent = "PAGAMENTO CONFIRMADO ✅ Inscrição validada!";
        debug.textContent = `Status: ${st.status} (${st.status_detail || ""})`.trim();
        return;
      }

      msg.textContent = "Aguardando pagamento...";
      debug.textContent = `Status: ${st.status}${st.status_detail ? " • " + st.status_detail : ""}`;

    }catch(e){
      debug.textContent = e.message;
    }
  }, 3500);
}

// ✅ copiar código PIX
async function copiarPix(){
  const text = (pixCode.value || "").trim();
  if(!text){
    alert("Código PIX ainda não carregou.");
    return;
  }

  try{
    if(navigator.clipboard && window.isSecureContext){
      await navigator.clipboard.writeText(text);
    }else{
      pixCode.focus();
      pixCode.select();
      document.execCommand("copy");
    }
    alert("Código PIX copiado!");
  }catch(e){
    alert("Não deu pra copiar automaticamente. Segura no texto e copie manualmente.");
  }
}
copyBtn.addEventListener("click", copiarPix);

form.addEventListener("submit", async (e)=>{
  e.preventDefault();
  btn.disabled = true;

  areaPix.classList.remove("hidden");
  qrImg.classList.add("hidden");
  paylinkWrap.classList.add("hidden");
  copyWrap.classList.add("hidden");
  pixCode.value = "";

  msg.textContent = "Gerando PIX...";
  debug.textContent = "";

  try{
    const whatsapp = onlyDigits(document.getElementById("whatsapp").value.trim());
    const nome = document.getElementById("nome").value.trim();
    const email = document.getElementById("email").value.trim() || "comprador@email.com";
    const descricao = document.getElementById("descricao").value.trim();
    const { total } = getTotal();

    const data = await criarPagamento({
      valor: total,
      descricao,
      email,
      whatsapp,
      nome
    });

    // ✅ QR
    if(data.qr_code_base64){
      qrImg.src = `data:image/png;base64,${data.qr_code_base64}`;
      qrImg.classList.remove("hidden");
    }

    // ✅ copia e cola
    if(data.qr_code){
      pixCode.value = data.qr_code;
      copyWrap.classList.remove("hidden");
    }

    // ✅ link de pagamento (aceita vários nomes que a API pode devolver)
    const url = data.payment_url || data.init_point || data.ticket_url || data.checkout_url || data.link;
    if(url){
      paylink.href = url;
      paylinkWrap.classList.remove("hidden");
    }

    msg.textContent = "PIX gerado!";
    debug.textContent = "Payment ID: " + (data.payment_id || data.id || "N/A");

    const pid = data.payment_id || data.id;
    if(pid) startPolling(pid);

  }catch(err){
    msg.textContent = err.message;
  }finally{
    btn.disabled = false;
  }
});
</script>

</body>
</html>